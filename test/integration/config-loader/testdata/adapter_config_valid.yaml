# Simple valid HyperFleet Adapter Configuration for testing

apiVersion: hyperfleet.redhat.com/v1alpha1
kind: AdapterConfig
metadata:
  name: example-adapter
  namespace: hyperfleet-system
  labels:
    hyperfleet.io/adapter-type: example
    hyperfleet.io/component: adapter

spec:
  adapter:
    version: "0.1.0"
  
  hyperfleetApi:
    timeout: 2s
    retryAttempts: 3
    retryBackoff: exponential

  kubernetes:
    apiVersion: "v1"

  # Parameters with all required variables
  params:
    - name: "hyperfleetApiBaseUrl"
      source: "env.HYPERFLEET_API_BASE_URL"
      type: "string"
      required: true

    - name: "hyperfleetApiVersion"
      source: "env.HYPERFLEET_API_VERSION"
      type: "string"
      default: "v1"

    - name: "hyperfleetApiToken"
      source: "env.HYPERFLEET_API_TOKEN"
      type: "string"
      required: true

    - name: "clusterId"
      source: "event.cluster_id"
      type: "string"
      required: true

    - name: "resourceId"
      source: "event.resource_id"
      type: "string"
      required: true

  # Preconditions with valid operators and CEL expressions
  preconditions:
    - name: "clusterStatus"
      apiCall:
        method: "GET"
        url: "{{ .hyperfleetApiBaseUrl }}/api/{{ .hyperfleetApiVersion }}/clusters/{{ .clusterId }}"
        timeout: 10s
        retryAttempts: 3
        retryBackoff: "exponential"
      capture:
        - name: "clusterName"
          field: "metadata.name"
        - name: "readyConditionStatus"
          expression: |
            status.conditions.filter(c, c.type == "Ready").size() > 0
              ? status.conditions.filter(c, c.type == "Ready")[0].status
              : "False"
        - name: "region"
          field: "spec.region"
        - name: "cloudProvider"
          field: "spec.provider"
        - name: "vpcId"
          field: "spec.vpc_id"
      # Structured conditions with valid operators
      conditions:
        - field: "readyConditionStatus"
          operator: "equals"
          value: "True"
        - field: "cloudProvider"
          operator: "in"
          value: ["aws", "gcp", "azure"]
        - field: "vpcId"
          operator: "exists"

    - name: "validationCheck"
      # Valid CEL expression
      expression: |
        readyConditionStatus == "True"

  # Resources with valid K8s manifests
  resources:
    - name: "clusterNamespace"
      manifest:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: "cluster-{{ .clusterId }}"
          labels:
            hyperfleet.io/cluster-id: "{{ .clusterId }}"
            hyperfleet.io/cluster-name: "{{ .clusterName }}"
            hyperfleet.io/region: "{{ .region }}"
            hyperfleet.io/provider: "{{ .cloudProvider }}"
            hyperfleet.io/managed-by: "{{ .metadata.name }}"
          annotations:
            hyperfleet.io/vpc-id: "{{ .vpcId }}"
      discovery:
        namespace: "*"  # Cluster-scoped resource (Namespace)
        bySelectors:
          labelSelector:
            hyperfleet.io/cluster-id: "{{ .clusterId }}"
            hyperfleet.io/managed-by: "{{ .metadata.name }}"

    - name: "clusterConfigMap"
      manifest:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: "cluster-config-{{ .clusterId }}"
          namespace: "cluster-{{ .clusterId }}"
          labels:
            hyperfleet.io/cluster-id: "{{ .clusterId }}"
      discovery:
        namespace: "cluster-{{ .clusterId }}"
        byName: "cluster-config-{{ .clusterId }}"

    - name: "externalTemplate"
      manifest:
        ref: "templates/deployment.yaml"
      discovery:
        namespace: "cluster-{{ .clusterId }}"
        bySelectors:
          labelSelector:
            hyperfleet.io/cluster-id: "{{ .clusterId }}"

  # Post-processing with valid CEL expressions
  post:
    payloads:
      - name: "clusterStatusPayload"
        build:
          conditions:
            applied:
              status:
                expression: |
                  resources.clusterNamespace.status.phase == "Active"
              reason:
                expression: |
                  has(resources.clusterNamespace.status.phase) ? "ResourcesCreated" : "Pending"
              message:
                expression: |
                  "Namespace status: " + resources.clusterNamespace.status.phase

            available:
              status:
                expression: |
                  resources.clusterConfigMap != null
              reason:
                expression: |
                  "ConfigMapReady"
              message:
                expression: |
                  "ConfigMap is available"

            health:
              status:
                expression: |
                  true
              reason:
                expression: |
                  "Healthy"
              message:
                expression: |
                  "All health checks passed"

          data:
            clusterReady:
              expression: |
                resources.clusterNamespace.status.phase == "Active"
              description: "Cluster namespace is active"

          observed_generation:
            value: "{{ .resourceId }}"
            description: "Resource ID processed"

          lastUpdated:
            value: "{{ now | date \"2006-01-02T15:04:05Z07:00\" }}"
            description: "Timestamp of status update"

    postActions:
      - name: "reportClusterStatus"
        apiCall:
          method: "POST"
          url: "{{ .hyperfleetApiBaseUrl }}/api/{{ .hyperfleetApiVersion }}/clusters/{{ .clusterId }}/status"
          headers:
            - name: "Authorization"
              value: "Bearer {{ .hyperfleetApiToken }}"
            - name: "Content-Type"
              value: "application/json"
          body: "{{ .clusterStatusPayload }}"
