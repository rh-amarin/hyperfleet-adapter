apiVersion: hyperfleet.redhat.com/v1alpha1
kind: AdapterConfig
metadata:
  name: test-adapter
  namespace: test-ns

spec:
  adapter:
    version: "1.0.0"

  hyperfleetAPI:
    timeout: 10s
    retryAttempts: 1
    retryBackoff: constant

  params:
    - name: hyperfleetApiBaseUrl
      source: env.HYPERFLEET_API_BASE_URL
      required: true
    
    - name: hyperfleetApiVersion
      source: env.HYPERFLEET_API_VERSION
      default: v1
      required: false
    
    - name: clusterId
      source: event.cluster_id
      required: true
    
    - name: resourceId
      source: event.resource_id
      required: true

  preconditions:
    - name: clusterStatus
      apiCall:
        method: GET
        url: "{{ .hyperfleetApiBaseUrl }}/api/{{ .hyperfleetApiVersion }}/clusters/{{ .clusterId }}"
        timeout: 5s
      capture:
        - name: clusterName
          field: metadata.name
        - name: readyConditionStatus
          expression: |
            status.conditions.filter(c, c.type == "Ready").size() > 0
              ? status.conditions.filter(c, c.type == "Ready")[0].status
              : "False"
        - name: region
          field: spec.region
        - name: cloudProvider
          field: spec.provider
        - name: vpcId
          field: spec.vpc_id
      conditions:
        - field: readyConditionStatus
          operator: equals
          value: "True"
        - field: cloudProvider
          operator: in
          value: ["aws", "gcp", "azure"]

  resources: []  # No K8s resources in this test - dry run mode

  post:
    payloads:
      - name: clusterStatusPayload
        build:
          conditions:
            health:
              status:
                expression: |
                  adapter.executionStatus == "success" && !adapter.resourcesSkipped
              reason:
                expression: |
                  adapter.resourcesSkipped ? "PreconditionNotMet" : (adapter.errorReason != "" ? adapter.errorReason : "Healthy")
              message:
                expression: |
                  adapter.skipReason != "" ? adapter.skipReason : (adapter.errorMessage != "" ? adapter.errorMessage : "All adapter operations completed successfully")
          clusterId:
            value: "{{ .clusterId }}"
          clusterName:
            expression: |
              clusterName != "" ? clusterName : "unknown"

    postActions:
      - name: reportClusterStatus
        apiCall:
          method: POST
          url: "{{ .hyperfleetApiBaseUrl }}/api/{{ .hyperfleetApiVersion }}/clusters/{{ .clusterId }}/status"
          body: "{{ .clusterStatusPayload }}"
          timeout: 5s

