# Dockerfile.integration
# Pre-built integration test image with envtest binaries
# This eliminates the need for dynamic installation during test runtime

FROM golang:1.25-alpine

# Install runtime dependencies
RUN apk add --no-cache curl tar openssl bash

# Install setup-envtest
RUN go install sigs.k8s.io/controller-runtime/tools/setup-envtest@latest

# Download and extract Kubernetes binaries (etcd, kube-apiserver, kubectl)
# Using 1.30.x for stability and active support
RUN /go/bin/setup-envtest use 1.30.x --bin-dir /usr/local/kubebuilder -p path > /tmp/envtest-path && \
    cat /tmp/envtest-path && \
    ENVTEST_PATH=$(cat /tmp/envtest-path) && \
    ln -sf ${ENVTEST_PATH}/etcd /usr/local/bin/etcd && \
    ln -sf ${ENVTEST_PATH}/kube-apiserver /usr/local/bin/kube-apiserver && \
    ln -sf ${ENVTEST_PATH}/kubectl /usr/local/bin/kubectl && \
    ls -lh /usr/local/bin/etcd /usr/local/bin/kube-apiserver /usr/local/bin/kubectl

# Create necessary directories
RUN mkdir -p /tmp/envtest/etcd /tmp/envtest/certs

# Generate service account keys (required by kube-apiserver)
RUN openssl genrsa -out /tmp/envtest/certs/sa.key 2048 && \
    openssl rsa -in /tmp/envtest/certs/sa.key -pubout -out /tmp/envtest/certs/sa.pub

# Create a token file for simple authentication (testing only)
# Format: token,username,uid,"group1,group2"
RUN echo "test-token,test-user,test-uid,system:masters" > /tmp/envtest/certs/token-auth-file

# Copy startup script to launch etcd and kube-apiserver
COPY scripts/start-envtest.sh /usr/local/bin/start-envtest.sh
RUN chmod +x /usr/local/bin/start-envtest.sh

# Default command: start envtest
CMD ["/usr/local/bin/start-envtest.sh"]

# Expose kube-apiserver port
EXPOSE 6443

# Label the image
LABEL maintainer="HyperFleet Team"
LABEL description="Integration test image with Kubernetes envtest binaries"
LABEL kubernetes.version="1.30.x"

